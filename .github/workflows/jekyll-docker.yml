name: üß± Build do Frontend e Publica√ß√£o no Docker Hub

on:
  push:
    branches:
      - infra/workflow-deploy
      - develop

jobs:
  # ============================================
  #   JOB DE LINT (CI)
  # ============================================
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: üì• Install dependencies
        run: npm ci --include=dev

      - name: üîé Run ESLint
        run: npm run lint

  # ============================================
  #   JOB DE BUILD & PUSH (DEPENDE DO LINT)
  # ============================================
  build-and-push:
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: üì• Install dependencies
        run: npm ci --include=dev

      - name: üèóÔ∏è Build React app
        run: npx vite build

      # -------------------------------
      #   GERANDO TAG INCREMENTAL
      # -------------------------------
      - name: üè∑Ô∏è Generate incremental tag
        id: tags
        run: |
          echo "tag=build-${GITHUB_RUN_NUMBER}" >> $GITHUB_OUTPUT

      - name: üîê Log in to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      # ------------------------------------
      #   BUILD DA IMAGEM COM AS DUAS TAGS
      # ------------------------------------
      - name: üê≥ Build Docker image (latest + incremental)
        run: |
          docker build \
            -t ${{ secrets.DOCKER_USERNAME }}/web-projeto:latest \
            -t ${{ secrets.DOCKER_USERNAME }}/web-projeto:${{ steps.tags.outputs.tag }} \
            .

      # -------------------------
      #   PUSH DAS DUAS IMAGENS
      # -------------------------
      - name: üöÄ Push Docker images to Docker Hub
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/web-projeto:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/web-projeto:${{ steps.tags.outputs.tag }}

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: üì° Deploy via EC2 P√∫blica
        uses: appleboy/ssh-action@v0.1.10
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          EC2_IP: ${{ secrets.EC2_IP }}
        with:
          host: ${{ secrets.EC2_IP }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "===================================="
            echo "üöÄ DEPLOY INICIADO - VIA BASTION"
            echo "===================================="

            ssh -o StrictHostKeyChecking=no ubuntu@10.0.0.253 "rm -f /home/ubuntu/limpar.sh"
            ssh -o StrictHostKeyChecking=no ubuntu@10.0.0.253 "cat > /home/ubuntu/limpar.sh" << 'EOF'
            #!/bin/bash
            set -e

            echo 'üõë Parando containers do Agendfy...'
            sudo docker ps -a --format "{{.Names}}" | grep -E "front-web-|front-psi-" | while read name; do
              echo "üõë Removendo $name..."
              sudo docker rm -f "$name"
            done

            echo 'üßπ Removendo imagens do Agendfy...'
            sudo docker images --format "{{.Repository}}:{{.Tag}}" | grep -E "agendfy/" | while read img; do
              echo "üóëÔ∏è Removendo imagem $img..."
              sudo docker rmi -f "$img"
            done
            echo 'üéâ Limpeza finalizada.'
            EOF

            ssh -o StrictHostKeyChecking=no ubuntu@10.0.0.253 "chmod +x /home/ubuntu/limpar.sh"

            ssh -o StrictHostKeyChecking=no ubuntu@10.0.0.253 "rm -f /home/ubuntu/deploy-front.sh"
            ssh -o StrictHostKeyChecking=no ubuntu@10.0.0.253 "cat > /home/ubuntu/deploy-front.sh" << 'EOF'
            #!/bin/bash
            set -e

            ENV_FILE="/home/ubuntu/env.js"

            cat > "$ENV_FILE" << EOX
            window.env = {
              VITE_API_URL: "http://${{ secrets.EC2_IP }}/api",
              VITE_RELATORIOS_URL: "http://${{ secrets.EC2_IP }}/relatorios"
            };
            EOX

            declare -A containers=(
              ["front-web-1"]="${{ secrets.DOCKER_USERNAME }}/web-projeto 3000"
              ["front-web-2"]="${{ secrets.DOCKER_USERNAME }}/web-projeto 3002"
              ["front-psi-1"]="${{ secrets.DOCKER_USERNAME }}/web-psi-rizerio 3001"
              ["front-psi-2"]="${{ secrets.DOCKER_USERNAME }}/web-psi-rizerio 3003"
            )

            for name in "${!containers[@]}"; do
              read -r image port <<< "${containers[$name]}"
              sudo docker stop "$name" 2>/dev/null || true
              sudo docker rm "$name" 2>/dev/null || true
              sudo docker pull "$image:latest"
              sudo docker run -d \
                --name "$name" \
                -e SERVER_ID="$name" \
                -p "$port":80 \
                -v "$ENV_FILE":/usr/share/nginx/html/env.js \
                "$image:latest"
            done

            echo "üéâ Deploy finalizado!"
            EOF

            ssh -o StrictHostKeyChecking=no ubuntu@10.0.0.253 "chmod +x /home/ubuntu/deploy-front.sh"

            ssh -o StrictHostKeyChecking=no ubuntu@10.0.0.253 "/home/ubuntu/limpar.sh"
            ssh -o StrictHostKeyChecking=no ubuntu@10.0.0.253 "/home/ubuntu/deploy-front.sh"

            echo "===================================="
            echo "üéâ DEPLOY CONCLU√çDO COM SUCESSO!"
            echo "===================================="
